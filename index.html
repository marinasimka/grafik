<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График работы</title>
    
    <!-- PWA мета-теги -->
    <meta name="application-name" content="График работы">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="График">
    <meta name="description" content="График работы локомотивной бригады">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#667eea">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    
    <!-- Фавиконки -->
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Стили -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Шапка с кнопкой темы и обновления -->
        <header class="header">
            <div class="header-top">
                <h1><i class="fas fa-train"></i> График работы локомотивной бригады</h1>
                <div class="header-buttons">
                    <button class="theme-toggle" id="themeToggle" title="Переключить тему">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="update-btn" id="updateButton" title="Обновить приложение" style="display:none;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="subtitle">ШТАДЛЕР</div>
            
            <!-- Карточка бригады -->
            <div class="brigade-card">
                <div class="brigade-info">
                    <div class="brigade-details">
                        <div class="person-row">
                            <div class="person">
                                <div class="person-role">
                                    <i class="fas fa-user-tie"></i>
                                    Машинист:
                                </div>
                                <div class="person-name">Ситко</div>
                            </div>
                            <div class="person">
                                <div class="person-role">
                                    <i class="fas fa-user-cog"></i>
                                    Помощник машиниста:
                                </div>
                                <div class="person-name">Фофанов</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="brigade-stats">
                    <div class="stat-item">
                        <div class="stat-label">Всего часов</div>
                        <div class="stat-value">161.1</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Календарь дней -->
        <div class="calendar">
            <div class="month-header">
                <h3><i class="fas fa-calendar-alt"></i> Февраль 2026</h3>
            </div>
            
            <div class="days-grid" id="daysGrid">
                <!-- Дни загрузятся через JavaScript -->
            </div>
        </div>

        <!-- Детальная информация о явке -->
        <div class="details-section" id="yavkaDetails">
            <!-- Информация появится при нажатии на явку -->
        </div>
    </div>

    <!-- Скрипты -->
    <script src="data.js"></script>
    <script src="script.js"></script>
    
    <!-- Service Worker регистрация с обновлением -->
    <script>
        // Регистрация Service Worker с контролем обновлений
        if ('serviceWorker' in navigator) {
            let newServiceWorker;
            
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('Service Worker зарегистрирован:', registration.scope);
                    
                    // Слушаем обновления
                    registration.addEventListener('updatefound', () => {
                        newServiceWorker = registration.installing;
                        console.log('Обнаружено обновление Service Worker');
                        
                        newServiceWorker.addEventListener('statechange', () => {
                            if (newServiceWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Новый контент доступен
                                console.log('Доступна новая версия приложения');
                                showUpdateNotification();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.log('Ошибка регистрации Service Worker:', error);
                });
            
            // Проверка обновлений при загрузке
            window.addEventListener('load', () => {
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({type: 'CHECK_UPDATE'});
                }
            });
            
            // Функция показа уведомления об обновлении
            function showUpdateNotification() {
                const updateButton = document.getElementById('updateButton');
                updateButton.style.display = 'block';
                updateButton.innerHTML = '<i class="fas fa-sync-alt"></i> Обновить';
                
                updateButton.onclick = () => {
                    if (newServiceWorker) {
                        newServiceWorker.postMessage({type: 'SKIP_WAITING'});
                        updateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обновление...';
                        updateButton.disabled = true;
                        
                        // Перезагружаем страницу после обновления
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                };
            }
        }
        
        // Переключение темы
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        // Проверяем сохранённую тему
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            themeIcon.className = 'fas fa-sun';
        }
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            
            if (document.body.classList.contains('dark-theme')) {
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        });
        
        // Автоопределение темы системы
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && !savedTheme) {
            document.body.classList.add('dark-theme');
            themeIcon.className = 'fas fa-sun';
        }
    </script>
</body>
</html>
